name: "Live API Verification"

# External Service Verification Tests (ESVTs)
#
# These tests hit REAL external APIs to verify our integration code works
# against actual API responses. They exist at the top of the test pyramid
# as deployment verification — catching contract drift, credential expiration,
# and parsing bugs that mocked tests cannot.
#
# Runs on: PRs targeting main (i.e., staging → main promotion)
#
# RULE: staging→main PRs MUST have all green lights including zero skips.
#       No test may be skipped — every connector must be fully operational.
#
# Cost tracking: Every test run posts/updates a PR comment with actual
# API request counts and estimated costs per connector.
#
# Terminology (for searchability):
#   - Broad integration tests (Martin Fowler)
#   - Deployment Verification Tests (Jez Humble, Continuous Delivery)
#   - External Service Verification Tests (ESVTs)

on:
  pull_request:
    branches: [main]

permissions:
  pull-requests: write
  contents: read

jobs:
  # -----------------------------------------------------------------------
  # System-wide acceptance test — runs on EVERY staging→main PR regardless
  # of file changes. This is the cheapest possible "are all services alive?"
  # gate. Catches credential expiration and API outages that happen
  # independently of code changes.
  # -----------------------------------------------------------------------
  acceptance:
    name: "Acceptance: all connectors healthy"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install 3.12
      - run: uv sync

      - name: Run acceptance test (auth smoke across all connectors)
        env:
          UNIPILE_API_KEY: ${{ secrets.UNIPILE_API_KEY }}
          UNIPILE_DSN: ${{ secrets.UNIPILE_DSN }}
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          X_USERNAME: ${{ secrets.X_USERNAME }}
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          POSTHOG_PROJECT_ID: ${{ secrets.POSTHOG_PROJECT_ID }}
          RB2B_API_KEY: ${{ secrets.RB2B_API_KEY }}
        run: |
          uv run --package unlock-source-access pytest \
            packages/source-access/tests/test_live_api.py \
            -v -s -m "acceptance" --tb=short \
            --junit-xml=acceptance-results.xml 2>&1 | tee acceptance-output.txt

      - name: Parse and report costs
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Extract request counts from pytest output
          echo "## Live API Verification — Cost Report" > cost-report.md
          echo "" >> cost-report.md
          echo "**Run:** acceptance | **Trigger:** \`${{ github.event.pull_request.head.sha }}\`" >> cost-report.md
          echo "" >> cost-report.md
          echo "| Test | API Requests | Status |" >> cost-report.md
          echo "|------|-------------|--------|" >> cost-report.md

          total_requests=0
          while IFS= read -r line; do
            if echo "$line" | grep -q "API requests:"; then
              label=$(echo "$line" | sed 's/.*\[\(.*\)\] API requests:.*/\1/')
              count=$(echo "$line" | sed 's/.*API requests: \([0-9]*\).*/\1/')
              total_requests=$((total_requests + count))
              echo "| $label | $count | — |" >> cost-report.md
            fi
          done < acceptance-output.txt

          # Extract pass/fail/skip from pytest output
          while IFS= read -r line; do
            if echo "$line" | grep -qE "PASSED|FAILED|SKIPPED"; then
              test_name=$(echo "$line" | sed 's/.*::\(.*\) .*/\1/')
              if echo "$line" | grep -q "PASSED"; then
                status="PASSED"
              elif echo "$line" | grep -q "FAILED"; then
                status="FAILED"
              elif echo "$line" | grep -q "SKIPPED"; then
                status="SKIPPED"
              fi
            fi
          done < acceptance-output.txt

          echo "" >> cost-report.md
          echo "**Total API requests this run:** $total_requests" >> cost-report.md
          echo "" >> cost-report.md

          # Estimated costs (conservative per-request estimates)
          echo "<details><summary>Cost estimates (per-request basis)</summary>" >> cost-report.md
          echo "" >> cost-report.md
          echo "| API | Est. per request | Notes |" >> cost-report.md
          echo "|-----|-----------------|-------|" >> cost-report.md
          echo "| Unipile | \$0.00 | Subscription-based |" >> cost-report.md
          echo "| X.com | ~\$0.005 | Basic tier pricing |" >> cost-report.md
          echo "| PostHog | \$0.00 | Free API tier |" >> cost-report.md
          echo "| RB2B | 1 credit | Credit-based |" >> cost-report.md
          echo "" >> cost-report.md
          echo "</details>" >> cost-report.md

          cat cost-report.md

      - name: Post cost report as PR comment
        if: always()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Find existing cost report comment or create new one
          COMMENT_TAG="<!-- live-api-cost-report -->"
          PR_NUMBER=${{ github.event.pull_request.number }}

          # Prepend the tag to the report
          echo "$COMMENT_TAG" > comment-body.md
          cat cost-report.md >> comment-body.md
          echo "" >> comment-body.md
          echo "---" >> comment-body.md
          echo "*Updated: $(date -u '+%Y-%m-%d %H:%M UTC') | Run: [#${{ github.run_number }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*" >> comment-body.md

          # Check if comment already exists
          EXISTING_COMMENT_ID=$(gh api \
            "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
            --jq ".[] | select(.body | startswith(\"$COMMENT_TAG\")) | .id" \
            2>/dev/null | head -1)

          if [ -n "$EXISTING_COMMENT_ID" ]; then
            gh api \
              "repos/${{ github.repository }}/issues/comments/${EXISTING_COMMENT_ID}" \
              -X PATCH \
              -f body="$(cat comment-body.md)"
            echo "Updated existing cost report comment #${EXISTING_COMMENT_ID}"
          else
            gh api \
              "repos/${{ github.repository }}/issues/${PR_NUMBER}/comments" \
              -f body="$(cat comment-body.md)"
            echo "Created new cost report comment"
          fi

  # -----------------------------------------------------------------------
  # Per-connector contract tests — on staging→main PRs, ALL connectors
  # are tested regardless of which files changed. This is the final gate
  # before production. No skips allowed.
  # -----------------------------------------------------------------------
  contract-unipile:
    name: "Contract: Unipile"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install 3.12
      - run: uv sync
      - name: Run Unipile contract tests
        env:
          UNIPILE_API_KEY: ${{ secrets.UNIPILE_API_KEY }}
          UNIPILE_DSN: ${{ secrets.UNIPILE_DSN }}
        run: |
          uv run --package unlock-source-access pytest \
            packages/source-access/tests/test_live_api.py \
            -v -s -m "contract" -k "Unipile" --tb=short

  contract-x:
    name: "Contract: X.com"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install 3.12
      - run: uv sync
      - name: Run X.com contract tests
        env:
          X_BEARER_TOKEN: ${{ secrets.X_BEARER_TOKEN }}
          X_USERNAME: ${{ secrets.X_USERNAME }}
        run: |
          uv run --package unlock-source-access pytest \
            packages/source-access/tests/test_live_api.py \
            -v -s -m "contract" -k "XContract" --tb=short

  contract-posthog:
    name: "Contract: PostHog"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install 3.12
      - run: uv sync
      - name: Run PostHog contract tests
        env:
          POSTHOG_API_KEY: ${{ secrets.POSTHOG_API_KEY }}
          POSTHOG_PROJECT_ID: ${{ secrets.POSTHOG_PROJECT_ID }}
        run: |
          uv run --package unlock-source-access pytest \
            packages/source-access/tests/test_live_api.py \
            -v -s -m "contract" -k "PostHog" --tb=short

  contract-rb2b:
    name: "Contract: RB2B"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: astral-sh/setup-uv@v5
      - run: uv python install 3.12
      - run: uv sync
      - name: Run RB2B contract tests
        env:
          RB2B_API_KEY: ${{ secrets.RB2B_API_KEY }}
        run: |
          uv run --package unlock-source-access pytest \
            packages/source-access/tests/test_live_api.py \
            -v -s -m "contract" -k "RB2B" --tb=short
