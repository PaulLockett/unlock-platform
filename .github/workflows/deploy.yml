name: Deploy

on:
  push:
    branches: [main]

# Only one deploy at a time — cancel in-progress if a new push arrives
concurrency:
  group: deploy
  cancel-in-progress: true

jobs:
  gate:
    name: Gate — run CI first
    uses: ./.github/workflows/ci.yml

  deploy:
    name: Deploy to production
    needs: gate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Supabase migrations — apply pending migrations to production
      # Uses --db-url directly to avoid config.toml CLI version compatibility issues
      - name: Install Supabase CLI
        uses: supabase/setup-cli@v1
      - name: Push migrations
        run: |
          # Resolve hostname to IPv4 — GitHub Actions runners lack IPv6 connectivity
          # to Supabase's direct database endpoint
          IPV4=$(getent ahostsv4 db.iabmwjrlbiyetasiiiht.supabase.co | head -1 | awk '{print $1}')
          DB_URL=$(echo "$SUPABASE_DB_URL" | sed "s|db.iabmwjrlbiyetasiiiht.supabase.co|${IPV4}|")
          supabase db push --db-url "$DB_URL"
        env:
          SUPABASE_DB_URL: ${{ secrets.SUPABASE_DB_URL }}

      # Railway and Vercel auto-deploy from main via their GitHub integrations.
      # No explicit deploy step needed here — just ensure CI passes first.
      - name: Deploy marker
        run: echo "CI passed — Railway and Vercel will auto-deploy from main"

  sync-env:
    name: Sync env vars to production
    needs: gate
    uses: ./.github/workflows/sync-env.yml
    with:
      environment: production
    secrets: inherit
