name: Temporal Bot

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  pull-requests: write

jobs:
  smoke:
    name: Temporal — schedule smoke tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install uv
        uses: astral-sh/setup-uv@v5

      - name: Set up Python 3.12
        run: uv python install 3.12

      - name: Install dependencies
        run: uv sync --all-packages

      - name: Run live schedule smoke tests
        id: smoke
        continue-on-error: true
        env:
          TEMPORAL_API_KEY: ${{ secrets.TEMPORAL_API_KEY }}
          TEMPORAL_NAMESPACE: ${{ secrets.TEMPORAL_NAMESPACE }}
          TEMPORAL_REGIONAL_ENDPOINT: ${{ secrets.TEMPORAL_REGIONAL_ENDPOINT }}
        run: |
          uv run --package unlock-workers pytest packages/scheduler/tests/test_live_schedules.py -v --tb=short 2>&1 | tee /tmp/temporal-results.txt

          # Parse counts from pytest's summary line (e.g., "= 1 passed in 2.63s =")
          # rather than grep -c which double-counts verbose output lines.
          SUMMARY=$(tail -1 /tmp/temporal-results.txt)
          TESTS_PASSED=$(echo "$SUMMARY" | grep -oP '\d+ passed' | grep -oP '\d+') || TESTS_PASSED=0
          TESTS_FAILED=$(echo "$SUMMARY" | grep -oP '\d+ failed' | grep -oP '\d+') || TESTS_FAILED=0
          TESTS_SKIPPED=$(echo "$SUMMARY" | grep -oP '\d+ skipped' | grep -oP '\d+') || TESTS_SKIPPED=0
          echo "passed=$TESTS_PASSED" >> "$GITHUB_OUTPUT"
          echo "failed=$TESTS_FAILED" >> "$GITHUB_OUTPUT"
          echo "skipped=$TESTS_SKIPPED" >> "$GITHUB_OUTPUT"

          # Compute status for PR comment
          if [ "$TESTS_SKIPPED" -gt 0 ] && [ "$TESTS_PASSED" -eq 0 ] && [ "$TESTS_FAILED" -eq 0 ]; then
            echo "status=⚠️ Skipped (no Temporal Cloud credentials)" >> "$GITHUB_OUTPUT"
          elif [ "$TESTS_FAILED" -gt 0 ]; then
            echo "status=❌ $TESTS_PASSED passed, $TESTS_FAILED failed" >> "$GITHUB_OUTPUT"
          else
            echo "status=✅ $TESTS_PASSED passed" >> "$GITHUB_OUTPUT"
          fi

      - name: Post or update PR comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: temporal-smoke
          message: |
            <img src="https://temporal.io/favicon.svg" alt="Temporal" width="20" height="20" align="absmiddle" /> **Temporal Schedule Smoke Tests**

            | | |
            |---|---|
            | **Smoke Tests** | ${{ steps.smoke.outputs.status }} |

            Full lifecycle: register → describe → pause → resume → list → cancel.
            Each run uses unique schedule IDs — no collisions, auto-cleanup on failure.

      - name: Require smoke tests pass
        if: steps.smoke.outcome == 'failure'
        run: |
          echo "Temporal schedule smoke tests failed — see test output above."
          exit 1
